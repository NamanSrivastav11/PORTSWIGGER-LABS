## LAB DESCRIPTION

<img width="900" height="469" alt="image" src="https://github.com/user-attachments/assets/127d627e-6a73-4fa4-915e-ee1de6bdc996" />

--------------------------------------------

## SOLUTION

Reference: https://portswigger.net/web-security/sql-injection

---------------------------------------------
This lab demonstrates a SQL injection vulnerability in a stock check feature where parameters are submitted as XML in the request body. A web application firewall (WAF) is in place and blocks obvious SQL injectino patterns, so the attack requires obfuscation via XML encoding to bypass the filter. The backing database contains a `users` table 
with usernames and passwords, and the objective is to retrieve the administrator's credentials and log in as that user.

<img width="1918" height="1106" alt="image" src="https://github.com/user-attachments/assets/79d6d17c-98bc-43c7-9016-05fcc21c0894" />

-----------------------------------

The vulnerable functionality is the "Check Stock" feature, which sends a `POST /product/stock` request with an XML body containing `productId` and `storeId` elements

The server uses the `storeId` value in a SQL query withot proper parameterization, and the response includes data derived from that query, enabling a UNION-based injection to exfilterate arbitrary data.

**Response**

```
POST /product/stock HTTP/2
Host: 0a360099034c5005812af7ba00140069.web-security-academy.net
Cookie: session=GfztEl4SWfB5j6BteVrXMo1v0XBO20ni
Content-Length: 108
Sec-Ch-Ua-Platform: "Windows"
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36
Sec-Ch-Ua: "Chromium";v="142", "Google Chrome";v="142", "Not_A Brand";v="99"
Content-Type: application/xml
Sec-Ch-Ua-Mobile: ?0
Accept: */*
Origin: https://0a360099034c5005812af7ba00140069.web-security-academy.net
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://0a360099034c5005812af7ba00140069.web-security-academy.net/product?productId=11
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Priority: u=1, i

<?xml version="1.0" encoding="UTF-8"?>
  <stockCheck>
        <productId>
              11
        </productId>
        <storeId>
              2
        </storeId>
  </stockCheck>
```
-----------------------------------------------

**Input evaluation in SQL**

By modifying the `storeId` in the XML body to contain a simple arithmetic expression `1+1` the application returns stock for a different store.

<img width="1166" height="602" alt="image" src="https://github.com/user-attachments/assets/c8a187e3-a459-43cc-82ff-644f142ebdfc" />

Now, attempting to append a standard UNION payload such as `1 UNION SELECT NULL` to `storeId` causes the application (or WAF) to block the request as an "attack detected" event.

<img width="1162" height="602" alt="image" src="https://github.com/user-attachments/assets/af6f007f-78c4-480f-a710-7bc7b8890617" />

This shows that the filter logic is keyword-based and works at the HTTP/request layer, not at the DB layer, so the injected SQL must be obfuscated before the WAF sees it.

**Filter bypass via XML encoding**

As the payload is embedded in XML, it can be obfuscated using XML entity encoding (via the **Burp Hackvector extension**)
Using Burp Suite with the Hackvector extension, the `storeId` injection is wrapped in a Hackvector tag `@hex_entities` which automatically encodes the SQL payload into its entity-encoded representations.

```PAYLOAD : 1 UNION SELECT null ```

> Hackvertor is a **tag-based conversion tool** that supports various escapes and encodings including HTML5 entities, hex, octal, unicode, url encoding etc. 
> It uses **XML-like tags** to specify the type of encoding/conversion used.

When the encoded request is sent, the WAF no longer flags it a an attack, confirming that XML encoding successfully bypass the filter.

<img width="1451" height="934" alt="image" src="https://github.com/user-attachments/assets/0f765910-08b8-443a-b2ce-fe3b5f856ccb" />

Now, send this modified payload via Repeater.

<img width="1451" height="934" alt="image" src="https://github.com/user-attachments/assets/8e0d6912-746a-4bb2-b460-b67a627bbbbf" />

----------------------------------------------------
**Crafting the payload via Hackvector**

Since only one column can be returned, concatenate username and password using the database's string concatenation operator.

```sql
1 UNION SELECT username || password FROM users
```

<img width="1451" height="934" alt="image" src="https://github.com/user-attachments/assets/f6cf03bf-cbb5-47bd-8899-7fbb19e2784b" />

After sending the encoded `UNION` query, the application responds with stock-like output containing concatenated `username-password` values from the `users` table.

<img width="1451" height="934" alt="image" src="https://github.com/user-attachments/assets/6084cb8f-8797-49bd-9627-b30d17fac779" />

-----------------------------------
Navigate to the login page and authenticate using the extracted administrator credentials.

<img width="1236" height="612" alt="image" src="https://github.com/user-attachments/assets/ddd11101-c3c2-41eb-aed7-a1a32b1bf8b0" />

----------------------------------
**Successful login as the admin user completes the lab objectives.**
